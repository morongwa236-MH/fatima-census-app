<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .admin-card {
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
        }
        .loading {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1d4ed8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .text-sm-condensed {
            font-size: 0.8rem;
            line-height: 1.2;
        }
        .form-input {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .sub-section {
            border-left: 4px solid #d1d5db;
            padding-left: 1rem;
            margin-left: 1rem;
            margin-top: 1rem;
        }
        .card {
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            animation: slide-down 0.3s ease-out;
        }
        @keyframes slide-down {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="p-8 md:p-12">
    <script>
        // IMPORTANT: Replace this with your Google Apps Script Web App URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbwiIPpDlNo6SJavIeAtk5OLdNpFd66xL4i9MHfkVnb-IzqfrY_g4mbDcYaQVq-GCTaz/exec';
        
        window.appState = {
            records: [],
            currentRecord: null
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const recordsList = document.getElementById('recordsList');
            const noResults = document.getElementById('noResults');
            const householdCountEl = document.getElementById('householdCount');
            const memberCountEl = document.getElementById('memberCount');
            const childCountEl = document.getElementById('childCount');
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const viewAllBtn = document.getElementById('viewAllBtn');
            const recordModal = document.getElementById('recordModal');
            const modalContent = document.getElementById('modalContent');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const editBtn = document.getElementById('editBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const editModal = document.getElementById('editModal');
            const closeEditModalBtn = document.getElementById('closeEditModalBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const editForm = document.getElementById('editForm');
            const editMembersContainer = document.getElementById('edit-membersContainer');
            const editChildrenContainer = document.getElementById('edit-childrenContainer');
            const editAddMemberBtn = document.getElementById('edit-addMemberBtn');
            const editAddChildBtn = document.getElementById('edit-addChildBtn');
            const editMessageBox = document.getElementById('edit-messageBox');

            searchBtn.addEventListener('click', () => {
                const query = searchInput.value;
                fetchData(query);
            });

            viewAllBtn.addEventListener('click', () => {
                searchInput.value = '';
                fetchData();
            });

            closeModalBtn.addEventListener('click', () => {
                recordModal.classList.add('hidden');
            });
            
            closeEditModalBtn.addEventListener('click', () => {
                editModal.classList.add('hidden');
            });
            
            cancelEditBtn.addEventListener('click', () => {
                editModal.classList.add('hidden');
            });

            editBtn.addEventListener('click', () => {
                if (window.appState.currentRecord) {
                    populateEditForm(window.appState.currentRecord);
                    recordModal.classList.add('hidden');
                    editModal.classList.remove('hidden');
                }
            });

            deleteBtn.addEventListener('click', () => {
                if (window.appState.currentRecord) {
                    showCustomModal('Are you sure you want to delete this record?', async (isConfirmed) => {
                        if (isConfirmed) {
                            try {
                                const payload = { action: 'deleteRecord', HouseholdID: window.appState.currentRecord.household.HouseholdID };
                                const response = await fetch(API_URL, {
                                    method: 'POST',
                                    body: JSON.stringify(payload),
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                showMessage('Record deleted successfully!', 'bg-green-200 text-green-800');
                                setTimeout(() => {
                                    recordModal.classList.add('hidden');
                                    fetchData();
                                    fetchCounts();
                                }, 2000);
                            } catch (error) {
                                showMessage('An error occurred. Please try again.', 'bg-red-200 text-red-800');
                                console.error('Error deleting record:', error);
                            }
                        }
                    });
                }
            });

            editAddMemberBtn.addEventListener('click', () => addMemberForm(editMembersContainer, editMembersContainer.childElementCount + 1));
            editAddChildBtn.addEventListener('click', () => addChildForm(editChildrenContainer, editChildrenContainer.childElementCount + 1));
            
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showMessage('Saving changes...', 'bg-blue-200 text-blue-800', editMessageBox);

                const formData = new FormData(editForm);
                const householdID = formData.get('householdID');
                const householdData = {
                    HouseholdID: householdID,
                    BlockName: formData.get('blockName'),
                    ResidentialAddress: formData.get('residentialAddress'),
                    ContactInformation: formData.get('contactInformation')
                };

                const membersData = [];
                editMembersContainer.querySelectorAll('.member-card').forEach((card, index) => {
                    const prefix = `edit-member-${index + 1}-`;
                    const member = {
                        MemberID: card.querySelector(`input[name="${prefix}ID"]`).value,
                        FirstName: card.querySelector(`input[name="${prefix}firstName"]`).value,
                        LastName: card.querySelector(`input[name="${prefix}lastName"]`).value,
                        DateOfBirth: card.querySelector(`input[name="${prefix}dateOfBirth"]`).value,
                        Catholic: card.querySelector(`select[name="${prefix}catholic"]`).value,
                        Occupation: card.querySelector(`input[name="${prefix}occupation"]`).value,
                        ChurchActivities: card.querySelector(`input[name="${prefix}churchActivities"]`).value,
                        SolidarityMinistry: card.querySelector(`input[name="${prefix}solidarityMinistry"]`).value,
                        Leadership: card.querySelector(`input[name="${prefix}leadership"]`).value,
                        Baptised: card.querySelector(`select[name="${prefix}baptised"]`).value,
                        BaptismDate: card.querySelector(`input[name="${prefix}baptismDate"]`).value,
                        BaptismRegistrationNo: card.querySelector(`input[name="${prefix}baptismRegistrationNo"]`).value,
                        ChurchOfBaptism: card.querySelector(`input[name="${prefix}churchOfBaptism"]`).value,
                        LocationOfChurch: card.querySelector(`input[name="${prefix}locationOfChurch"]`).value,
                        FirstCommunion: card.querySelector(`select[name="${prefix}firstCommunion"]`).value,
                        FirstCommunionDate: card.querySelector(`input[name="${prefix}firstCommunionDate"]`).value,
                        ChurchOfFirstCommunion: card.querySelector(`input[name="${prefix}churchOfFirstCommunion"]`).value,
                        Confirmation: card.querySelector(`select[name="${prefix}confirmation"]`).value,
                        ConfirmationDate: card.querySelector(`input[name="${prefix}confirmationDate"]`).value,
                        ChurchOfConfirmation: card.querySelector(`input[name="${prefix}churchOfConfirmation"]`).value,
                        MaritalStatus: card.querySelector(`select[name="${prefix}maritalStatus"]`).value,
                        CivilCourtMarriageDate: card.querySelector(`input[name="${prefix}civilCourtMarriageDate"]`).value,
                        ChurchMarriageDate: card.querySelector(`input[name="${prefix}churchMarriageDate"]`).value,
                        ChurchMarriagePlace: card.querySelector(`input[name="${prefix}churchMarriagePlace"]`).value,
                        Divorced: card.querySelector(`select[name="${prefix}divorced"]`).value,
                        Dikabelo: card.querySelector(`select[name="${prefix}dikabelo"]`).value,
                        DateOfLastDikabelo: card.querySelector(`input[name="${prefix}dateOfLastDikabelo"]`).value,
                    };
                    membersData.push(member);
                });

                const childrenData = [];
                editChildrenContainer.querySelectorAll('.child-card').forEach((card, index) => {
                    const prefix = `edit-child-${index + 1}-`;
                    const child = {
                        ChildID: card.querySelector(`input[name="${prefix}ID"]`).value,
                        FirstName: card.querySelector(`input[name="${prefix}firstName"]`).value,
                        LastName: card.querySelector(`input[name="${prefix}lastName"]`).value,
                        DateOfBirth: card.querySelector(`input[name="${prefix}dateOfBirth"]`).value,
                        Age: card.querySelector(`input[name="${prefix}age"]`).value,
                        Catholic: card.querySelector(`select[name="${prefix}catholic"]`).value,
                        ChurchActivities: card.querySelector(`input[name="${prefix}churchActivities"]`).value,
                        Baptised: card.querySelector(`select[name="${prefix}baptised"]`).value,
                        BaptismDate: card.querySelector(`input[name="${prefix}baptismDate"]`).value,
                        BaptismRegistrationNo: card.querySelector(`input[name="${prefix}baptismRegistrationNo"]`).value,
                        ChurchOfBaptism: card.querySelector(`input[name="${prefix}churchOfBaptism"]`).value,
                        LocationOfChurch: card.querySelector(`input[name="${prefix}locationOfChurch"]`).value,
                        FirstCommunion: card.querySelector(`select[name="${prefix}firstCommunion"]`).value,
                        FirstCommunionDate: card.querySelector(`input[name="${prefix}firstCommunionDate"]`).value,
                        ChurchOfFirstCommunion: card.querySelector(`input[name="${prefix}churchOfFirstCommunion"]`).value,
                        Confirmation: card.querySelector(`select[name="${prefix}confirmation"]`).value,
                        ConfirmationDate: card.querySelector(`input[name="${prefix}confirmationDate"]`).value,
                        ChurchOfConfirmation: card.querySelector(`input[name="${prefix}churchOfConfirmation"]`).value,
                    };
                    childrenData.push(child);
                });

                try {
                    const payload = { 
                        action: 'editRecord',
                        HouseholdID: householdID,
                        household: householdData,
                        members: membersData,
                        children: childrenData
                    };
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'application/json' }
                    });

                    showMessage('Record updated successfully!', 'bg-green-200 text-green-800', editMessageBox);
                    setTimeout(() => {
                        editModal.classList.add('hidden');
                        fetchData();
                        fetchCounts();
                    }, 2000);

                } catch (error) {
                    showMessage('An error occurred. Please try again.', 'bg-red-200 text-red-800', editMessageBox);
                    console.error('Error submitting form:', error);
                }
            });
            
            // Initial data fetch calls
            fetchData();
            fetchCounts();
        });

        async function fetchCounts() {
            try {
                const response = await fetch(`${API_URL}?action=getCounts`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                householdCountEl.textContent = data.totalHouseholds || 0;
                memberCountEl.textContent = data.totalMembers || 0;
                childCountEl.textContent = data.totalChildren || 0;
            } catch (error) {
                console.error('Error fetching counts:', error);
                householdCountEl.textContent = 'N/A';
                memberCountEl.textContent = 'N/A';
                childCountEl.textContent = 'N/A';
            }
        }

        async function fetchData(query = '') {
            loadingIndicator.classList.remove('hidden');
            recordsList.innerHTML = '';
            noResults.classList.add('hidden');

            try {
                const url = query ? `${API_URL}?q=${encodeURIComponent(query)}` : API_URL;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                window.appState.records = data.records;
                renderRecords(window.appState.records);
            } catch (error) {
                console.error("Error fetching data: ", error);
                noResults.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function renderRecords(records) {
            recordsList.innerHTML = '';
            if (!records || records.length === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
                records.forEach(record => {
                    const household = record.household;
                    const recordDiv = document.createElement('div');
                    recordDiv.className = 'admin-card hover:bg-gray-50 transition duration-300 cursor-pointer';
                    recordDiv.innerHTML = `
                        <h3 class="text-lg font-bold text-blue-600">${household.BlockName} - ${household.ResidentialAddress}</h3>
                        <p class="text-sm-condensed text-gray-500">Household ID: ${household.HouseholdID}</p>
                        <p class="text-gray-700 mt-2 font-semibold">Members: <span class="font-normal">${record.members.length}</span></p>
                        <p class="text-gray-700 font-semibold">Children: <span class="font-normal">${record.children.length}</span></p>
                    `;
                    recordDiv.addEventListener('click', () => showRecordDetails(record));
                    recordsList.appendChild(recordDiv);
                });
            }
        }
        
        function showRecordDetails(record) {
            window.appState.currentRecord = record;
            const household = record.household;
            const members = record.members;
            const children = record.children;
            
            let content = `
                <h4 class="text-lg font-bold text-gray-800 mb-2">Household Information</h4>
                <ul class="list-disc list-inside space-y-1 mb-6">
                    <li><strong>Household ID:</strong> ${household.HouseholdID || 'N/A'}</li>
                    <li><strong>Block Name:</strong> ${household.BlockName || 'N/A'}</li>
                    <li><strong>Residential Address:</strong> ${household.ResidentialAddress || 'N/A'}</li>
                    <li><strong>Contact:</strong> ${household.ContactInformation || 'N/A'}</li>
                </ul>
            `;

            if (members && members.length > 0) {
                content += `<h4 class="text-lg font-bold text-gray-800 mb-2">Members</h4>`;
                members.forEach(member => {
                    content += `<div class="p-4 bg-gray-100 rounded-lg mb-4">
                        <p class="font-semibold">${member.FirstName || 'N/A'} ${member.LastName || 'N/A'}</p>
                        <ul class="list-disc list-inside text-sm-condensed space-y-1 mt-2">
                            <li><strong>Date of Birth:</strong> ${member.DateOfBirth || 'N/A'}</li>
                            <li><strong>Catholic?:</strong> ${member.Catholic || 'N/A'}</li>
                            <li><strong>Occupation:</strong> ${member.Occupation || 'N/A'}</li>
                            <li><strong>Church Activities:</strong> ${member.ChurchActivities || 'N/A'}</li>
                            <li><strong>Solidarity/Ministry:</strong> ${member.SolidarityMinistry || 'N/A'}</li>
                            <li><strong>Leadership:</strong> ${member.Leadership || 'N/A'}</li>
                            <li><strong>Marital Status:</strong> ${member.MaritalStatus || 'N/A'}</li>
                            <li><strong>Divorced?:</strong> ${member.Divorced || 'N/A'}</li>
                            <li><strong>Civil Court Marriage Date:</strong> ${member.CivilCourtMarriageDate || 'N/A'}</li>
                            <li><strong>Church Marriage Date:</strong> ${member.ChurchMarriageDate || 'N/A'}</li>
                            <li><strong>Church Marriage Place:</strong> ${member.ChurchMarriagePlace || 'N/A'}</li>
                            <li><strong>Baptised?:</strong> ${member.Baptised || 'N/A'}</li>
                            <li><strong>Date of Baptism:</strong> ${member.BaptismDate || 'N/A'}</li>
                            <li><strong>Baptism Reg. No:</strong> ${member.BaptismRegistrationNo || 'N/A'}</li>
                            <li><strong>Church of Baptism:</strong> ${member.ChurchOfBaptism || 'N/A'}</li>
                            <li><strong>Location of Church:</strong> ${member.LocationOfChurch || 'N/A'}</li>
                            <li><strong>First Communion?:</strong> ${member.FirstCommunion || 'N/A'}</li>
                            <li><strong>Date 1st Communion:</strong> ${member.FirstCommunionDate || 'N/A'}</li>
                            <li><strong>Church of 1st Communion:</strong> ${member.ChurchOfFirstCommunion || 'N/A'}</li>
                            <li><strong>Confirmation?:</strong> ${member.Confirmation || 'N/A'}</li>
                            <li><strong>Date of Confirmation:</strong> ${member.ConfirmationDate || 'N/A'}</li>
                            <li><strong>Church of Confirmation:</strong> ${member.ChurchOfConfirmation || 'N/A'}</li>
                            <li><strong>Dikabelo?:</strong> ${member.Dikabelo || 'N/A'}</li>
                            <li><strong>Date of Last Dikabelo:</strong> ${member.DateOfLastDikabelo || 'N/A'}</li>
                        </ul>
                    </div>`;
                });
            }
            
            if (children && children.length > 0) {
                content += `<h4 class="text-lg font-bold text-gray-800 mb-2">Children</h4>`;
                children.forEach(child => {
                    content += `<div class="p-4 bg-gray-100 rounded-lg mb-4">
                        <p class="font-semibold">${child.FirstName || 'N/A'} ${child.LastName || 'N/A'}</p>
                        <ul class="list-disc list-inside text-sm-condensed space-y-1 mt-2">
                            <li><strong>Date of Birth:</strong> ${child.DateOfBirth || 'N/A'}</li>
                            <li><strong>Age:</strong> ${child.Age || 'N/A'}</li>
                            <li><strong>Catholic?:</strong> ${child.Catholic || 'N/A'}</li>
                            <li><strong>Church Activities:</strong> ${child.ChurchActivities || 'N/A'}</li>
                            <li><strong>Baptised?:</strong> ${child.Baptised || 'N/A'}</li>
                            <li><strong>Date of Baptism:</strong> ${child.BaptismDate || 'N/A'}</li>
                            <li><strong>Baptism Reg. No:</strong> ${child.BaptismRegistrationNo || 'N/A'}</li>
                            <li><strong>Church of Baptism:</strong> ${child.ChurchOfBaptism || 'N/A'}</li>
                            <li><strong>Location of Church:</strong> ${child.LocationOfChurch || 'N/A'}</li>
                            <li><strong>First Communion?:</strong> ${child.FirstCommunion || 'N/A'}</li>
                            <li><strong>Date 1st Communion:</strong> ${child.FirstCommunionDate || 'N/A'}</li>
                            <li><strong>Church of 1st Communion:</strong> ${child.ChurchOfFirstCommunion || 'N/A'}</li>
                            <li><strong>Confirmation?:</strong> ${child.Confirmation || 'N/A'}</li>
                            <li><strong>Date of Confirmation:</strong> ${child.ConfirmationDate || 'N/A'}</li>
                            <li><strong>Church of Confirmation:</strong> ${child.ChurchOfConfirmation || 'N/A'}</li>
                        </ul>
                    </div>`;
                });
            }
            
            modalContent.innerHTML = content;
            recordModal.classList.remove('hidden');
        }
        
        function populateEditForm(record) {
            editForm.reset();
            editMembersContainer.innerHTML = '';
            editChildrenContainer.innerHTML = '';
            
            document.getElementById('edit-householdID').value = record.household.HouseholdID;
            document.getElementById('edit-blockName').value = record.household.BlockName;
            document.getElementById('edit-residentialAddress').value = record.household.ResidentialAddress;
            document.getElementById('edit-contactInformation').value = record.household.ContactInformation;
            
            let memberCount = 0;
            if (record.members && record.members.length > 0) {
                record.members.forEach(member => addMemberForm(editMembersContainer, ++memberCount, member));
            } else {
                addMemberForm(editMembersContainer, 1);
            }
            
            let childCount = 0;
            if (record.children && record.children.length > 0) {
                record.children.forEach(child => addChildForm(editChildrenContainer, ++childCount, child));
            } else {
                addChildForm(editChildrenContainer, 1);
            }
        }

        function addMemberForm(container, index, data = {}) {
            const memberDiv = document.createElement('div');
            memberDiv.className = 'card member-card';
            memberDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Member #${index}</h3>
                    <button type="button" class="remove-btn text-gray-400 hover:text-red-500 transition duration-300"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <input type="hidden" name="edit-member-${index}-ID" value="${data.MemberID || 'new-member-' + Date.now() + '-' + index}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block font-medium">First Name</label><input type="text" name="edit-member-${index}-firstName" class="form-input" value="${data.FirstName || ''}" required></div>
                    <div><label class="block font-medium">Last Name</label><input type="text" name="edit-member-${index}-lastName" class="form-input" value="${data.LastName || ''}" required></div>
                    <div><label class="block font-medium">Date of Birth</label><input type="date" name="edit-member-${index}-dateOfBirth" class="form-input" value="${data.DateOfBirth || ''}" required></div>
                    <div>
                        <label class="block font-medium">Catholic?</label>
                        <select name="edit-member-${index}-catholic" class="form-input" required><option value="">Select...</option><option value="Yes" ${data.Catholic === 'Yes' ? 'selected' : ''}>Yes</option><option value="No" ${data.Catholic === 'No' ? 'selected' : ''}>No</option></select>
                    </div>
                    <div><label class="block font-medium">Occupation</label><input type="text" name="edit-member-${index}-occupation" class="form-input" value="${data.Occupation || ''}"></div>
                    <div><label class="block font-medium">Church Activities</label><input type="text" name="edit-member-${index}-churchActivities" class="form-input" value="${data.ChurchActivities || ''}"></div>
                    <div><label class="block font-medium">Solidarity/Ministry</label><input type="text" name="edit-member-${index}-solidarityMinistry" class="form-input" value="${data.SolidarityMinistry || ''}"></div>
                    <div><label class="block font-medium">Leadership</label><input type="text" name="edit-member-${index}-leadership" class="form-input" value="${data.Leadership || ''}"></div>
                </div>
                <div class="sub-section"><h4 class="font-bold text-sm text-gray-600 mb-2">Sacraments</h4>
                    <div><label class="block font-medium">Baptised?</label><select name="edit-member-${index}-baptised" class="form-input baptized-select"><option value="No" ${data.Baptised !== 'Yes' ? 'selected' : ''}>No</option><option value="Yes" ${data.Baptised === 'Yes' ? 'selected' : ''}>Yes</option></select></div>
                    <div class="baptised-fields ${data.Baptised !== 'Yes' ? 'hidden' : ''} mt-2 space-y-2">
                        <div><label class="block font-medium">Date of Baptism</label><input type="date" name="edit-member-${index}-baptismDate" class="form-input" value="${data.BaptismDate || ''}"></div>
                        <div><label class="block font-medium">Registration Number</label><input type="text" name="edit-member-${index}-baptismRegistrationNo" class="form-input" value="${data.BaptismRegistrationNo || ''}"></div>
                        <div><label class="block font-medium">Church of Baptism</label><input type="text" name="edit-member-${index}-churchOfBaptism" class="form-input" value="${data.ChurchOfBaptism || ''}"></div>
                        <div><label class="block font-medium">Location of Church</label><input type="text" name="edit-member-${index}-locationOfChurch" class="form-input" value="${data.LocationOfChurch || ''}"></div>
                    </div>
                    <div><label class="block font-medium">1st Communion?</label><select name="edit-member-${index}-firstCommunion" class="form-input communion-select"><option value="No" ${data.FirstCommunion !== 'Yes' ? 'selected' : ''}>No</option><option value="Yes" ${data.FirstCommunion === 'Yes' ? 'selected' : ''}>Yes</option></select></div>
                    <div class="communion-fields ${data.FirstCommunion !== 'Yes' ? 'hidden' : ''} mt-2 space-y-2">
                        <div><label class="block font-medium">Date 1st Communion</label><input type="date" name="edit-member-${index}-firstCommunionDate" class="form-input" value="${data.FirstCommunionDate || ''}"></div>
                        <div><label class="block font-medium">Church of 1st Communion</label><input type="text" name="edit-member-${index}-churchOfFirstCommunion" class="form-input" value="${data.ChurchOfFirstCommunion || ''}"></div>
                    </div>
                    <div><label class="block font-medium">Confirmed?</label><select name="edit-member-${index}-confirmation" class="form-input confirmation-select"><option value="No" ${data.Confirmation !== 'Yes' ? 'selected' : ''}>No</option><option value="Yes" ${data.Confirmation === 'Yes' ? 'selected' : ''}>Yes</option></select></div>
                    <div class="confirmation-fields ${data.Confirmation !== 'Yes' ? 'hidden' : ''} mt-2 space-y-2">
                        <div><label class="block font-medium">Date of Confirmation</label><input type="date" name="edit-member-${index}-confirmationDate" class="form-input" value="${data.ConfirmationDate || ''}"></div>
                        <div><label class="block font-medium">Church of Confirmation</label><input type="text" name="edit-member-${index}-churchOfConfirmation" class="form-input" value="${data.ChurchOfConfirmation || ''}"></div>
                    </div>
                </div>
                <div class="sub-section"><h4 class="font-bold text-sm text-gray-600 mb-2">Marital Status</h4>
                    <div><label class="block font-medium">Marital Status</label><select name="edit-member-${index}-maritalStatus" class="form-input marital-status-select"><option value="Single" ${data.MaritalStatus === 'Single' ? 'selected' : ''}>Single</option><option value="Married" ${data.MaritalStatus === 'Married' ? 'selected' : ''}>Married</option><option value="Widower" ${data.MaritalStatus === 'Widower' ? 'selected' : ''}>Widow(er)</option></select></div>
                    <div class="marital-fields ${data.MaritalStatus !== 'Married' && data.MaritalStatus !== 'Widower' ? 'hidden' : ''} mt-2 space-y-2">
                        <div><label class="block font-medium">Civil Court Marriage Date</label><input type="date" name="edit-member-${index}-civilCourtMarriageDate" class="form-input" value="${data.CivilCourtMarriageDate || ''}"></div>
                        <div><label class="block font-medium">Church Marriage Date</label><input type="date" name="edit-member-${index}-churchMarriageDate" class="form-input" value="${data.ChurchMarriageDate || ''}"></div>
                        <div><label class="block font-medium">Church Marriage Place</label><input type="text" name="edit-member-${index}-churchMarriagePlace" class="form-input" value="${data.ChurchMarriagePlace || ''}"></div>
                        <div><label class="block font-medium">Divorced?</label><select name="edit-member-${index}-divorced" class="form-input"><option value="No" ${data.Divorced !== 'Yes' ? 'selected' : ''}>No</option><option value="Yes" ${data.Divorced === 'Yes' ? 'selected' : ''}>Yes</option></select></div>
                    </div>
                </div>
                <div class="sub-section"><h4 class="font-bold text-sm text-gray-600 mb-2">Dikabelo</h4>
                    <div><label class="block font-medium">Dikabelo?</label><select name="edit-member-${index}-dikabelo" class="form-input dikabelo-select"><option value="No" ${data.Dikabelo !== 'Yes' ? 'selected' : ''}>No</option><option value="Yes" ${data.Dikabelo === 'Yes' ? 'selected' : ''}>Yes</option></select></div>
                    <div class="dikabelo-fields ${data.Dikabelo !== 'Yes' ? 'hidden' : ''} mt-2 space-y-2">
                        <div><label class="block font-medium">Date of Last Dikabelo</label><input type="date" name="edit-member-${index}-dateOfLastDikabelo" class="form-input" value="${data.DateOfLastDikabelo || ''}"></div>
                    </div>
                </div>
            `;
            container.appendChild(memberDiv);
            memberDiv.querySelector('.remove-btn').addEventListener('click', () => memberDiv.remove());
            setupConditionalFields(memberDiv);
        }

        function addChildForm(container, index, data = {}) {
            const childDiv = document.createElement('div');
            childDiv.className = 'card child-card';
            childDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Child #${index}</h3>
                    <button type="button" class="remove-btn text-gray-400 hover:text-red-500 transition duration-300"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <input type="hidden" name="edit-child-${index}-ID" value="${data.ChildID || 'new-child-' + Date.now() + '-' + index}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block font-medium">First Name</label><input type="text" name="edit-child-${index}-firstName" class="form-input" value="${data.FirstName || ''}" required></div>
                    <div><label class="block font-medium">Last Name</label><input type="text" name="edit-child-${index}-lastName" class="form-input" value="${data.LastName || ''}" required></div>
                    <div><label class="block font-medium">Date of Birth</label><input type="date" name="edit-child-${index}-dateOfBirth" class="form-input" value="${data.DateOfBirth || ''}" required></div>
                    <div><label class="block font-medium">Age</label><input type="number" name="edit-child-${index}-age" class="form-input" value="${data.Age || ''}" required></div>
                    <div>
                        <label class="block font-medium">Catholic?</label>
                        <select name="edit-child-${index}-catholic" class="form-input" required><option value="">Select...</option><option value="Yes" ${data.Catholic === 'Yes' ? 'selected' : ''}>Yes</option><option value="No" ${data.Catholic === 'No' ? 'selected' : ''}>No</option></select>
                    </div>
                    <div><label class="block font-medium">Church Activities</label><input type="text" name="edit-child-${index}-churchActivities" class="form-input" value="${data.ChurchActivities || ''}"></div>
                </div>
                <div class="sub-section"><h4 class="font-bold text-sm text-gray-600 mb-2">Sacraments</h4>
                    <div><label class="block font-medium">Baptised?</label><select name="edit-child-${index}-baptised" class="form-input baptized-select"><option value="No" ${data.Baptised !== 'Yes' ? 'selected' : ''}>No</option><option value="Yes" ${data.Baptised === 'Yes' ? 'selected' : ''}>Yes</option></select></div>
                    <div class="baptised-fields ${data.Baptised !== 'Yes' ? 'hidden' : ''} mt-2 space-y-2">
                        <div><label class="block font-medium">Date of Baptism</label><input type="date" name="edit-child-${index}-baptismDate" class="form-input" value="${data.BaptismDate || ''}"></div>
                        <div><label class="block font-medium">Registration Number</label><input type="text" name="edit-child-${index}-baptismRegistrationNo" class="form-input" value="${data.BaptismRegistrationNo || ''}"></div>
                        <div><label class="block font-medium">Church of Baptism</label><input type="text" name="edit-child-${index}-churchOfBaptism" class="form-input" value="${data.ChurchOfBaptism || ''}"></div>
                        <div><label class="block font-medium">Location of Church</label><input type="text" name="edit-child-${index}-locationOfChurch" class="form-input" value="${data.LocationOfChurch || ''}"></div>
                    </div>
                    <div><label class="block font-medium">1st Communion?</label><select name="edit-child-${index}-firstCommunion" class="form-input communion-select"><option value="No" ${data.FirstCommunion !== 'Yes' ? 'selected' : ''}>No</option><option value="Yes" ${data.FirstCommunion === 'Yes' ? 'selected' : ''}>Yes</option></select></div>
                    <div class="communion-fields ${data.FirstCommunion !== 'Yes' ? 'hidden' : ''} mt-2 space-y-2">
                        <div><label class="block font-medium">Date 1st Communion</label><input type="date" name="edit-child-${index}-firstCommunionDate" class="form-input" value="${data.FirstCommunionDate || ''}"></div>
                        <div><label class="block font-medium">Church of 1st Communion</label><input type="text" name="edit-child-${index}-churchOfFirstCommunion" class="form-input" value="${data.ChurchOfFirstCommunion || ''}"></div>
                    </div>
                    <div><label class="block font-medium">Confirmed?</label><select name="edit-child-${index}-confirmation" class="form-input confirmation-select"><option value="No" ${data.Confirmation !== 'Yes' ? 'selected' : ''}>No</option><option value="Yes" ${data.Confirmation === 'Yes' ? 'selected' : ''}>Yes</option></select></div>
                    <div class="confirmation-fields ${data.Confirmation !== 'Yes' ? 'hidden' : ''} mt-2 space-y-2">
                        <div><label class="block font-medium">Date of Confirmation</label><input type="date" name="edit-child-${index}-confirmationDate" class="form-input" value="${data.ConfirmationDate || ''}"></div>
                        <div><label class="block font-medium">Church of Confirmation</label><input type="text" name="edit-child-${index}-churchOfConfirmation" class="form-input" value="${data.ChurchOfConfirmation || ''}"></div>
                    </div>
                </div>
            `;
            container.appendChild(childDiv);
            childDiv.querySelector('.remove-btn').addEventListener('click', () => childDiv.remove());
            setupConditionalFields(childDiv);
        }

        function setupConditionalFields(container) {
            container.querySelectorAll('.baptized-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const fields = e.target.closest('.sub-section').querySelector('.baptised-fields');
                    if (e.target.value === 'Yes') { fields.classList.remove('hidden'); } else { fields.classList.add('hidden'); }
                });
            });

            container.querySelectorAll('.communion-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const fields = e.target.closest('.sub-section').querySelector('.communion-fields');
                    if (e.target.value === 'Yes') { fields.classList.remove('hidden'); } else { fields.classList.add('hidden'); }
                });
            });

            container.querySelectorAll('.confirmation-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const fields = e.target.closest('.sub-section').querySelector('.confirmation-fields');
                    if (e.target.value === 'Yes') { fields.classList.remove('hidden'); } else { fields.classList.add('hidden'); }
                });
            });
            
            container.querySelectorAll('.marital-status-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const fields = e.target.closest('.sub-section').querySelector('.marital-fields');
                    if (e.target.value === 'Married' || e.target.value === 'Widower') { fields.classList.remove('hidden'); } else { fields.classList.add('hidden'); }
                });
            });
            
            container.querySelectorAll('.dikabelo-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const fields = e.target.closest('.sub-section').querySelector('.dikabelo-fields');
                    if (e.target.value === 'Yes') { fields.classList.remove('hidden'); } else { fields.classList.add('hidden'); }
                });
            });
        }
        
        function showMessage(message, colorClass, container = editMessageBox) {
            container.textContent = message;
            container.className = `mt-4 p-4 rounded-lg text-sm text-center font-semibold ${colorClass} visible`;
            container.classList.remove('hidden');
        }

        function showCustomModal(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[100] p-4 modal';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm modal-content">
                    <p class="text-center font-semibold mb-4">${message}</p>
                    <div class="flex gap-4">
                        <button id="confirmBtn" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg">Confirm</button>
                        <button id="cancelBtn" class="flex-1 px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('confirmBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
                onConfirm(true);
            });
            document.getElementById('cancelBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
                onConfirm(false);
            });
        }
    </script>

    <div class="max-w-6xl mx-auto space-y-8">
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">Admin Dashboard</h1>
            <p class="text-gray-600">Manage census records for Our Lady of Fatima Shrine</p>
        </header>

        <!-- Search and Filter Section -->
        <div class="admin-card">
            <h2 class="text-xl font-bold mb-4">Search Records</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="searchInput" placeholder="Search by name, address, or block" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                <button id="searchBtn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-300">Search</button>
                <button id="viewAllBtn" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-300">View All</button>
            </div>
        </div>
        
        <!-- Counts Section -->
        <div class="admin-card grid grid-cols-1 md:grid-cols-3 gap-6">
            <h2 class="text-xl font-bold col-span-full">Quick Counts</h2>
            <div class="bg-indigo-100 p-4 rounded-lg flex flex-col justify-center items-center">
                <p class="text-indigo-800 font-semibold">Total Households</p>
                <span id="householdCount" class="text-3xl font-bold text-indigo-900">...</span>
            </div>
            <div class="bg-indigo-100 p-4 rounded-lg flex flex-col justify-center items-center">
                <p class="text-indigo-800 font-semibold">Total Members</p>
                <span id="memberCount" class="text-3xl font-bold text-indigo-900">...</span>
            </div>
            <div class="bg-indigo-100 p-4 rounded-lg flex flex-col justify-center items-center">
                <p class="text-indigo-800 font-semibold">Total Children</p>
                <span id="childCount" class="text-3xl font-bold text-indigo-900">...</span>
            </div>
        </div>

        <!-- Results Section -->
        <div class="admin-card">
            <h2 class="text-xl font-bold mb-4">Census Records</h2>
            <div id="resultsContainer">
                <div id="loadingIndicator" class="flex justify-center py-8 hidden">
                    <div class="loading"></div>
                </div>
                <div id="recordsList" class="space-y-6">
                    <!-- Records will be displayed here -->
                </div>
                <div id="noResults" class="hidden text-center text-gray-500 py-8">
                    <p>No records found. Try a different search.</p>
                </div>
            </div>
        </div>

        <!-- Modal for details/editing (hidden by default) -->
        <div id="recordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50 modal">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Record Details</h3>
                    <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div id="modalContent">
                    <!-- Content will be loaded here -->
                </div>
                <div class="flex gap-4 mt-6">
                    <button id="editBtn" class="flex-1 px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition duration-300">
                        <i class="fa-solid fa-pen-to-square mr-2"></i> Edit Record
                    </button>
                    <button id="deleteBtn" class="flex-1 px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-300">
                        <i class="fa-solid fa-trash-can mr-2"></i> Delete Record
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal for editing a record -->
        <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50 modal">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Edit Record</h3>
                    <button id="closeEditModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <form id="editForm" class="space-y-6">
                    <div class="form-section bg-blue-50 text-gray-800 p-4 rounded-xl">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-house"></i> Household Information</h2>
                        <input type="hidden" id="edit-householdID" name="householdID">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="edit-blockName" class="block font-medium">Block Name</label>
                                <input type="text" id="edit-blockName" name="blockName" class="form-input" required>
                            </div>
                            <div class="space-y-2">
                                <label for="edit-residentialAddress" class="block font-medium">Residential Address</label>
                                <input type="text" id="edit-residentialAddress" name="residentialAddress" class="form-input" required>
                            </div>
                            <div class="space-y-2 col-span-1 md:col-span-2">
                                <label for="edit-contactInformation" class="block font-medium">Contact Information</label>
                                <input type="tel" id="edit-contactInformation" name="contactInformation" class="form-input" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section bg-green-50 text-gray-800 p-4 rounded-xl">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-user-group"></i> Members' Information</h2>
                        <div id="edit-membersContainer" class="space-y-6"></div>
                        <button type="button" id="edit-addMemberBtn" class="mt-6 w-full md:w-auto px-6 py-3 bg-green-500 text-white rounded-full font-semibold">
                            <i class="fa-solid fa-plus mr-2"></i> Add Another Member
                        </button>
                    </div>
                    
                    <div class="form-section bg-red-50 text-gray-800 p-4 rounded-xl">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-child"></i> Children's Information</h2>
                        <div id="edit-childrenContainer" class="space-y-6"></div>
                        <button type="button" id="edit-addChildBtn" class="mt-6 w-full md:w-auto px-6 py-3 bg-red-500 text-white rounded-full font-semibold">
                            <i class="fa-solid fa-plus mr-2"></i> Add Another Child
                        </button>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-300">
                            Save Changes
                        </button>
                        <button type="button" id="cancelEditBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-300">
                            Cancel
                        </button>
                    </div>
                </form>
                <div id="edit-messageBox" class="mt-4 p-4 rounded-lg text-sm text-center font-semibold hidden"></div>
            </div>
        </div>
    </div>
</body>
</html>

