<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Our Lady of Fatima Shrine</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
.card { background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem; }
.hidden { display: none; }
</style>
</head>
<body class="p-8 md:p-12">

<div class="max-w-6xl mx-auto">
  <header class="text-center mb-6">
    <h1 class="text-3xl font-bold">Admin Dashboard - Our Lady of Fatima Shrine</h1>
    <input type="text" id="searchBox" placeholder="Search by First Name, Last Name, Block or Address" class="mt-4 p-3 w-full md:w-1/2 rounded-lg border">
  </header>

  <div id="recordsContainer" class="space-y-4"></div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white rounded-3xl p-8 max-w-4xl w-full overflow-y-auto max-h-[90vh]">
    <h2 class="text-2xl font-bold mb-4">Edit Household Record</h2>
    <form id="editForm" class="space-y-6"></form>
    <div class="flex justify-end gap-4 mt-4">
      <button type="button" id="closeModal" class="px-6 py-3 bg-gray-300 rounded-full font-semibold">Cancel</button>
      <button type="submit" form="editForm" class="px-6 py-3 bg-gradient-blue text-white rounded-full font-bold">Save Changes</button>
    </div>
  </div>
</div>

<script>
const API_URL='YOUR_DEPLOYED_WEB_APP_URL';

let records=[];

const recordsContainer=document.getElementById('recordsContainer');
const searchBox=document.getElementById('searchBox');
const editModal=document.getElementById('editModal');
const editForm=document.getElementById('editForm');
let currentEditId=null;

// Fetch all records
async function fetchRecords(){
  const res=await fetch(`${API_URL}?action=`);
  records=await res.json();
  renderRecords(records);
}

// Render record cards
function renderRecords(list){
  recordsContainer.innerHTML='';
  list.forEach(r=>{
    const div=document.createElement('div'); div.className='card flex justify-between items-center';
    div.innerHTML=`<div>
      <p><strong>Block:</strong> ${r.household.blockName}</p>
      <p><strong>Address:</strong> ${r.household.residentialAddress}</p>
      <p><strong>Contact:</strong> ${r.household.contactInformation}</p>
      <p><strong>Members:</strong> ${r.members.length}, <strong>Children:</strong> ${r.children.length}</p>
    </div>
    <div class="flex gap-2">
      <button class="editBtn px-4 py-2 bg-green-500 text-white rounded-lg" data-id="${r.householdId}"><i class="fa-solid fa-pen"></i> Edit</button>
      <button class="deleteBtn px-4 py-2 bg-red-500 text-white rounded-lg" data-id="${r.householdId}"><i class="fa-solid fa-trash"></i> Delete</button>
    </div>`;
    recordsContainer.appendChild(div);
  });

  document.querySelectorAll('.editBtn').forEach(btn=>{
    btn.addEventListener('click',()=>openEditModal(btn.dataset.id));
  });
  document.querySelectorAll('.deleteBtn').forEach(btn=>{
    btn.addEventListener('click',()=>deleteRecord(btn.dataset.id));
  });
}

// Search functionality
searchBox.addEventListener('input',()=>{
  const q=searchBox.value.toLowerCase();
  const filtered=records.filter(r=>r.household.blockName.toLowerCase().includes(q) || 
                                    r.household.residentialAddress.toLowerCase().includes(q) ||
                                    r.members.some(m=>m.firstName.toLowerCase().includes(q) || m.lastName.toLowerCase().includes(q)));
  renderRecords(filtered);
});

// Delete record
async function deleteRecord(id){
  if(!confirm('Are you sure to delete this record?')) return;
  await fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'delete', householdId:id})});
  await fetchRecords();
}

// Open Edit Modal
async function openEditModal(id){
  currentEditId=id;
  const res=await fetch(`${API_URL}?action=getDetails&householdId=${id}`);
  const data=await res.json();
  editForm.innerHTML=generateEditFormHTML(data);
  editModal.classList.remove('hidden');
  setupConditionalFields(editForm);
}

// Close modal
document.getElementById('closeModal').addEventListener('click',()=>editModal.classList.add('hidden'));

// Submit Edit Form
editForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const fd=new FormData(editForm);
  const household={
    householdId: currentEditId,
    blockName: fd.get('blockName'),
    residentialAddress: fd.get('residentialAddress'),
    contactInformation: fd.get('contactInformation')
  };

  const members=[];
  const children=[];
  // Collect members
  for(let i=1;;i++){
    if(!fd.get(`member-${i}-firstName`)) break;
    members.push({
      firstName: fd.get(`member-${i}-firstName`),
      lastName: fd.get(`member-${i}-lastName`),
      dateOfBirth: fd.get(`member-${i}-dateOfBirth`),
      catholic: fd.get(`member-${i}-catholic`)
    });
  }
  // Collect children
  for(let i=1;;i++){
    if(!fd.get(`child-${i}-firstName`)) break;
    children.push({
      firstName: fd.get(`child-${i}-firstName`),
      lastName: fd.get(`child-${i}-lastName`),
      dateOfBirth: fd.get(`child-${i}-dateOfBirth`),
      age: fd.get(`child-${i}-age`),
      catholic: fd.get(`child-${i}-catholic`)
    });
  }

  await fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'update', household, members, children})});
  editModal.classList.add('hidden');
  await fetchRecords();
});

// Generate Edit Form HTML (simplified version, can replicate index.html form completely)
function generateEditFormHTML(data){
  let html=`<div class="space-y-4">
    <label>Block Name</label><input name="blockName" value="${data.household.blockName}" class="w-full border rounded-lg p-2" required>
    <label>Address</label><input name="residentialAddress" value="${data.household.residentialAddress}" class="w-full border rounded-lg p-2" required>
    <label>Contact</label><input name="contactInformation" value="${data.household.contactInformation}" class="w-full border rounded-lg p-2" required>
    </div><h3 class="text-lg font-bold mt-4">Members</h3><div id="editMembersContainer" class="space-y-4">`;

  data.members.forEach((m,i)=>{
    html+=`<div class="border p-3 rounded-lg">
      <label>First Name</label><input name="member-${i+1}-firstName" value="${m.firstName}" class="w-full border rounded-lg p-1" required>
      <label>Last Name</label><input name="member-${i+1}-lastName" value="${m.lastName}" class="w-full border rounded-lg p-1" required>
      <label>Date of Birth</label><input type="date" name="member-${i+1}-dateOfBirth" value="${m.dateOfBirth}" class="w-full border rounded-lg p-1">
      <label>Catholic?</label><select name="member-${i+1}-catholic"><option ${m.catholic==='Yes'?'selected':''}>Yes</option><option ${m.catholic==='No'?'selected':''}>No</option></select>
    </div>`;
  });
  html+='</div><h3 class="text-lg font-bold mt-4">Children</h3><div id="editChildrenContainer" class="space-y-4">';
  data.children.forEach((c,i)=>{
    html+=`<div class="border p-3 rounded-lg">
      <label>First Name</label><input name="child-${i+1}-firstName" value="${c.firstName}" class="w-full border rounded-lg p-1" required>
      <label>Last Name</label><input name="child-${i+1}-lastName" value="${c.lastName}" class="w-full border rounded-lg p-1" required>
      <label>Date of Birth</label><input type="date" name="child-${i+1}-dateOfBirth" value="${c.dateOfBirth}" class="w-full border rounded-lg p-1">
      <label>Age</label><input type="number" name="child-${i+1}-age" value="${c.age}" class="w-full border rounded-lg p-1">
      <label>Catholic?</label><select name="child-${i+1}-catholic"><option ${c.catholic==='Yes'?'selected':''}>Yes</option><option ${c.catholic==='No'?'selected':''}>No</option></select>
    </div>`;
  });
  html+='</div>';
  return html;
}

// Placeholder for conditional fields setup (if you want full replication of index.html logic)
function setupConditionalFields(container){ /* implement if needed */ }

fetchRecords();
</script>

</body>
</html>
