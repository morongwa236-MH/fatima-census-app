<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Our Lady of Fatima Shrine</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
.card { background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 1rem; padding: 1.5rem; margin-top: 1.5rem; }
.sub-section { border-left: 4px solid #d1d5db; padding-left: 1rem; margin-left: 1rem; margin-top: 1rem; }
.button { padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: 0.2s; }
.button:hover { transform: scale(1.05); }
</style>
</head>
<body class="p-6 md:p-12">
<div class="max-w-6xl mx-auto bg-white rounded-3xl shadow-xl p-8 md:p-12">
  <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-6">Admin Dashboard</h1>

  <!-- Search -->
  <div class="mb-6">
    <input type="text" id="searchInput" placeholder="Search by First Name, Last Name, Block, or Address" class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg">
  </div>

  <!-- Records Table -->
  <div id="recordsContainer"></div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-8 rounded-2xl max-w-5xl w-full overflow-auto max-h-[90vh]">
      <h2 class="text-2xl font-bold mb-4">Edit Household</h2>
      <form id="editForm" class="space-y-6 overflow-auto">
        <input type="hidden" name="householdId">
        <div class="form-section bg-blue-50 p-4 rounded-lg">
          <h3 class="font-bold mb-2">Household Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label>Block Name</label><input type="text" name="blockName" class="form-input w-full" required></div>
            <div><label>Residential Address</label><input type="text" name="residentialAddress" class="form-input w-full" required></div>
            <div class="md:col-span-2"><label>Contact Info</label><input type="text" name="contactInformation" class="form-input w-full" required></div>
          </div>
        </div>

        <!-- Members Section -->
        <div class="form-section bg-green-50 p-4 rounded-lg">
          <h3 class="font-bold mb-2">Members</h3>
          <div id="editMembersContainer"></div>
          <button type="button" id="editAddMemberBtn" class="button bg-green-500 text-white mt-2"><i class="fa-solid fa-plus"></i> Add Member</button>
        </div>

        <!-- Children Section -->
        <div class="form-section bg-red-50 p-4 rounded-lg">
          <h3 class="font-bold mb-2">Children</h3>
          <div id="editChildrenContainer"></div>
          <button type="button" id="editAddChildBtn" class="button bg-red-500 text-white mt-2"><i class="fa-solid fa-plus"></i> Add Child</button>
        </div>

        <div class="flex justify-end gap-2">
          <button type="button" id="closeEditModal" class="button bg-gray-400 text-white">Cancel</button>
          <button type="submit" class="button bg-blue-600 text-white">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzH86E97gGZLE622geaGyMs_EG9hC-P2z3o1cDfUxpG5W2VpmpSzU7sd96iEhPB_4RzSg/exec'; // Replace with your Apps Script URL

let allRecords = [];
let memberCount = 0;
let childCount = 0;

// Fetch records from Google Sheet
async function fetchRecords() {
  const res = await fetch(API_URL + '?action=read');
  const data = await res.json();
  allRecords = data;
  displayRecords(data);
}

// Display records
function displayRecords(records) {
  const container = document.getElementById('recordsContainer');
  container.innerHTML = '';
  records.forEach(hh => {
    const div = document.createElement('div');
    div.className = 'card p-4';
    div.innerHTML = `
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold">${hh.blockName} - ${hh.residentialAddress}</h3>
        <div class="flex gap-2">
          <button class="edit-btn button bg-blue-500 text-white" data-id="${hh.householdId}"><i class="fa-solid fa-pen"></i> Edit</button>
          <button class="delete-btn button bg-red-500 text-white" data-id="${hh.householdId}"><i class="fa-solid fa-trash"></i> Delete</button>
        </div>
      </div>
      <div><strong>Members:</strong> ${hh.members.map(m=>m.firstName+' '+m.lastName).join(', ')}</div>
      <div><strong>Children:</strong> ${hh.children.map(c=>c.firstName+' '+c.lastName).join(', ')}</div>
    `;
    container.appendChild(div);
  });

  // Edit buttons
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => openEditModal(btn.dataset.id));
  });
  // Delete buttons
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => deleteRecord(btn.dataset.id));
  });
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', e => {
  const q = e.target.value.toLowerCase();
  const filtered = allRecords.filter(hh =>
    hh.blockName.toLowerCase().includes(q) ||
    hh.residentialAddress.toLowerCase().includes(q) ||
    hh.members.some(m=>m.firstName.toLowerCase().includes(q) || m.lastName.toLowerCase().includes(q)) ||
    hh.children.some(c=>c.firstName.toLowerCase().includes(q) || c.lastName.toLowerCase().includes(q))
  );
  displayRecords(filtered);
});

// Delete record
async function deleteRecord(id) {
  if(confirm('Are you sure you want to delete this record?')) {
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({action:'delete', householdId:id}),
      headers:{'Content-Type':'application/json'}
    });
    fetchRecords();
  }
}

// Edit Modal
const editModal = document.getElementById('editModal');
const editForm = document.getElementById('editForm');
const editMembersContainer = document.getElementById('editMembersContainer');
const editChildrenContainer = document.getElementById('editChildrenContainer');

document.getElementById('closeEditModal').addEventListener('click', ()=>editModal.classList.add('hidden'));

function openEditModal(id) {
  const hh = allRecords.find(r=>r.householdId===id);
  editForm.householdId.value = id;
  editForm.blockName.value = hh.blockName;
  editForm.residentialAddress.value = hh.residentialAddress;
  editForm.contactInformation.value = hh.contactInformation;

  editMembersContainer.innerHTML='';
  memberCount=0;
  hh.members.forEach(m=>{ addEditMemberForm(m); });

  editChildrenContainer.innerHTML='';
  childCount=0;
  hh.children.forEach(c=>{ addEditChildForm(c); });

  editModal.classList.remove('hidden');
}

// Add member in edit form
function addEditMemberForm(data={}) {
  memberCount++;
  const div = document.createElement('div');
  div.className = 'card mb-2';
  div.innerHTML = `
    <div class="flex justify-between items-center mb-2">
      <h4 class="font-bold">Member #${memberCount}</h4>
      <button type="button" class="remove-btn button bg-red-500 text-white">Remove</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
      <div><label>First Name</label><input type="text" name="member-${memberCount}-firstName" class="form-input w-full" value="${data.firstName||''}" required></div>
      <div><label>Last Name</label><input type="text" name="member-${memberCount}-lastName" class="form-input w-full" value="${data.lastName||''}" required></div>
      <div><label>Date of Birth</label><input type="date" name="member-${memberCount}-dateOfBirth" class="form-input w-full" value="${data.dateOfBirth||''}" required></div>
      <div><label>Catholic?</label><select name="member-${memberCount}-catholic" class="form-input w-full" required>
        <option ${data.catholic==='Yes'?'selected':''}>Yes</option>
        <option ${data.catholic==='No'?'selected':''}>No</option>
      </select></div>
    </div>
  `;
  editMembersContainer.appendChild(div);
  div.querySelector('.remove-btn').addEventListener('click', ()=>div.remove());
}

// Add child in edit form
function addEditChildForm(data={}) {
  childCount++;
  const div = document.createElement('div');
  div.className = 'card mb-2';
  div.innerHTML = `
    <div class="flex justify-between items-center mb-2">
      <h4 class="font-bold">Child #${childCount}</h4>
      <button type="button" class="remove-btn button bg-red-500 text-white">Remove</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
      <div><label>First Name</label><input type="text" name="child-${childCount}-firstName" class="form-input w-full" value="${data.firstName||''}" required></div>
      <div><label>Last Name</label><input type="text" name="child-${childCount}-lastName" class="form-input w-full" value="${data.lastName||''}" required></div>
      <div><label>Date of Birth</label><input type="date" name="child-${childCount}-dateOfBirth" class="form-input w-full" value="${data.dateOfBirth||''}" required></div>
      <div><label>Age</label><input type="number" name="child-${childCount}-age" class="form-input w-full" value="${data.age||''}" required></div>
      <div><label>Catholic?</label><select name="child-${childCount}-catholic" class="form-input w-full" required>
        <option ${data.catholic==='Yes'?'selected':''}>Yes</option>
        <option ${data.catholic==='No'?'selected':''}>No</option>
      </select></div>
    </div>
  `;
  editChildrenContainer.appendChild(div);
  div.querySelector('.remove-btn').addEventListener('click', ()=>div.remove());
}

// Add new empty member/child
document.getElementById('editAddMemberBtn').addEventListener('click', ()=>addEditMemberForm());
document.getElementById('editAddChildBtn').addEventListener('click', ()=>addEditChildForm());

// Submit edit
editForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const fd = new FormData(editForm);
  const householdId = fd.get('householdId');

  const household = {
    blockName: fd.get('blockName'),
    residentialAddress: fd.get('residentialAddress'),
    contactInformation: fd.get('contactInformation')
  };

  const members = [];
  for(let i=1;i<=memberCount;i++){
    if(fd.get(`member-${i}-firstName`)){
      members.push({
        firstName: fd.get(`member-${i}-firstName`),
        lastName: fd.get(`member-${i}-lastName`),
        dateOfBirth: fd.get(`member-${i}-dateOfBirth`),
        catholic: fd.get(`member-${i}-catholic`)
      });
    }
  }

  const children = [];
  for(let i=1;i<=childCount;i++){
    if(fd.get(`child-${i}-firstName`)){
      children.push({
        firstName: fd.get(`child-${i}-firstName`),
        lastName: fd.get(`child-${i}-lastName`),
        dateOfBirth: fd.get(`child-${i}-dateOfBirth`),
        age: fd.get(`child-${i}-age`),
        catholic: fd.get(`child-${i}-catholic`)
      });
    }
  }

  await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
    action:'update', householdId, household, members, children
  }) });

  editModal.classList.add('hidden');
  fetchRecords();
});

// Initialize
fetchRecords();
</script>
</body>
</html>

