<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Census Record</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .form-section {
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .card {
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .bg-gradient-blue {
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
        }
        .bg-gradient-green {
            background: linear-gradient(135deg, #059669, #10b981);
        }
        .bg-gradient-purple {
            background: linear-gradient(135deg, #7c3aed, #9333ea);
        }
        .loading {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1d4ed8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-6">

    <!-- Loading screen -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="loading mb-4"></div>
            <p class="text-gray-600 font-semibold">Loading record...</p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto form-container hidden">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight mb-2">Edit Census Record</h1>
            <p class="text-lg text-gray-500">Update household, member, and children details.</p>
        </header>

        <form id="editForm" class="space-y-6">

            <!-- Household Information -->
            <div class="card form-section bg-gradient-blue text-white shadow-lg">
                <h2 class="text-2xl font-bold mb-4">Household Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="householdID" class="block text-sm font-medium mb-1">Household ID</label>
                        <input type="text" id="householdID" name="householdID" class="w-full p-3 rounded-lg text-gray-800 bg-gray-200 cursor-not-allowed" readonly>
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium mb-1">Address</label>
                        <input type="text" id="address" name="address" class="w-full p-3 rounded-lg text-gray-800" required>
                    </div>
                    <div>
                        <label for="blockName" class="block text-sm font-medium mb-1">Block Name</label>
                        <input type="text" id="blockName" name="blockName" class="w-full p-3 rounded-lg text-gray-800" required>
                    </div>
                    <div>
                        <label for="householdHeadName" class="block text-sm font-medium mb-1">Household Head's Name</label>
                        <input type="text" id="householdHeadName" name="householdHeadName" class="w-full p-3 rounded-lg text-gray-800" required>
                    </div>
                </div>
            </div>

            <!-- Members Information -->
            <div class="card form-section bg-gradient-green text-white shadow-lg">
                <h2 class="text-2xl font-bold mb-4">Members</h2>
                <div id="membersContainer" class="space-y-6">
                    <!-- Member forms will be dynamically added here -->
                </div>
                <button type="button" id="addMemberBtn" class="mt-4 w-full md:w-auto px-6 py-3 bg-white text-gray-800 font-bold rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i> Add Member
                </button>
            </div>

            <!-- Children Information -->
            <div class="card form-section bg-gradient-purple text-white shadow-lg">
                <h2 class="text-2xl font-bold mb-4">Children (Under 18)</h2>
                <div id="childrenContainer" class="space-y-6">
                    <!-- Children forms will be dynamically added here -->
                </div>
                <button type="button" id="addChildBtn" class="mt-4 w-full md:w-auto px-6 py-3 bg-white text-gray-800 font-bold rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i> Add Child
                </button>
            </div>
            
            <div class="flex justify-end gap-4 mt-8">
                <a href="admin.html" class="px-6 py-3 text-gray-700 font-bold rounded-lg hover:bg-gray-200 transition-colors duration-200 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> Cancel
                </a>
                <button type="submit" id="saveBtn" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Save Changes
                </button>
            </div>
        </form>

        <!-- Message Box -->
        <div id="messageBox" class="mt-8 p-4 rounded-lg text-sm text-center font-semibold transition-all duration-300 hidden"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const API_URL = 'https://script.google.com/macros/s/AKfycby0sCIEYi_NLjDMzUmB7-3oiVoQlJErtKd9DNt4vmlSWPDpSMkF42WA1CcEOGA0_bW7Wg/exec'; // REMEMBER TO UPDATE THIS
            const urlParams = new URLSearchParams(window.location.search);
            const householdId = urlParams.get('id');

            const loadingOverlay = document.getElementById('loadingOverlay');
            const formContainer = document.querySelector('.form-container');
            const editForm = document.getElementById('editForm');
            const membersContainer = document.getElementById('membersContainer');
            const childrenContainer = document.getElementById('childrenContainer');
            const addMemberBtn = document.getElementById('addMemberBtn');
            const addChildBtn = document.getElementById('addChildBtn');
            const messageBox = document.getElementById('messageBox');

            if (!householdId) {
                showMessage('No record ID found in the URL. Please return to the admin dashboard.', 'bg-red-200 text-red-800');
                loadingOverlay.classList.add('hidden');
                return;
            }

            // Function to display messages
            function showMessage(message, colorClass) {
                messageBox.textContent = message;
                messageBox.className = `mt-8 p-4 rounded-lg text-sm text-center font-semibold ${colorClass}`;
                messageBox.classList.remove('hidden');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 5000);
            }

            // Function to fetch and populate the form with a specific record's data
            async function fetchAndPopulateForm() {
                try {
                    const response = await fetch(`${API_URL}?action=getRecord&id=${encodeURIComponent(householdId)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const record = await response.json();

                    if (!record) {
                        showMessage('Record not found.', 'bg-red-200 text-red-800');
                        loadingOverlay.classList.add('hidden');
                        return;
                    }

                    // Populate household data
                    document.getElementById('householdID').value = record.household.HouseholdID;
                    document.getElementById('address').value = record.household.Address;
                    document.getElementById('blockName').value = record.household.BlockName;
                    document.getElementById('householdHeadName').value = record.household.HouseholdHeadName;

                    // Populate members
                    membersContainer.innerHTML = '';
                    if (record.members) {
                        record.members.forEach(member => addMemberForm(member));
                    }
                    
                    // Populate children
                    childrenContainer.innerHTML = '';
                    if (record.children) {
                        record.children.forEach(child => addChildForm(child));
                    }

                    loadingOverlay.classList.add('hidden');
                    formContainer.classList.remove('hidden');

                } catch (error) {
                    showMessage('Failed to load record.', 'bg-red-200 text-red-800');
                    loadingOverlay.classList.add('hidden');
                    console.error('Error fetching record:', error);
                }
            }

            // Helper function to create a unique ID for dynamic fields
            function generateId(prefix, index) {
                return `${prefix}-${index}-${Date.now()}`;
            }

            // Add member form dynamically
            function addMemberForm(member = null) {
                const memberCount = membersContainer.children.length;
                const memberId = member?.MemberID || `new-member-${memberCount + 1}`;
                const memberHtml = `
                    <div class="card p-4 bg-white text-gray-800 shadow-sm" data-id="${memberId}">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Member ${memberCount + 1}</h3>
                            <button type="button" class="remove-btn text-red-500 hover:text-red-700 text-xl"><i class="fas fa-trash"></i></button>
                        </div>
                        <input type="hidden" name="memberID[]" value="${memberId}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="${generateId('firstName', memberCount)}" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                                <input type="text" id="${generateId('firstName', memberCount)}" name="firstName[]" value="${member?.firstName || ''}" class="w-full p-2 rounded-lg border border-gray-300" required>
                            </div>
                            <div>
                                <label for="${generateId('lastName', memberCount)}" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                                <input type="text" id="${generateId('lastName', memberCount)}" name="lastName[]" value="${member?.lastName || ''}" class="w-full p-2 rounded-lg border border-gray-300" required>
                            </div>
                            <div>
                                <label for="${generateId('contactNumber', memberCount)}" class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label>
                                <input type="tel" id="${generateId('contactNumber', memberCount)}" name="contactNumber[]" value="${member?.contactNumber || ''}" class="w-full p-2 rounded-lg border border-gray-300" required>
                            </div>
                            <div>
                                <label for="${generateId('email', memberCount)}" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="${generateId('email', memberCount)}" name="email[]" value="${member?.email || ''}" class="w-full p-2 rounded-lg border border-gray-300">
                            </div>
                            <div>
                                <label for="${generateId('gender', memberCount)}" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                                <select id="${generateId('gender', memberCount)}" name="gender[]" class="w-full p-2 rounded-lg border border-gray-300" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male" ${member?.gender === 'Male' ? 'selected' : ''}>Male</option>
                                    <option value="Female" ${member?.gender === 'Female' ? 'selected' : ''}>Female</option>
                                    <option value="Other" ${member?.gender === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="${generateId('memberStatus', memberCount)}" class="block text-sm font-medium text-gray-700 mb-1">Member Status</label>
                                <select id="${generateId('memberStatus', memberCount)}" name="memberStatus[]" class="w-full p-2 rounded-lg border border-gray-300" required>
                                    <option value="">Select Status</option>
                                    <option value="Adult" ${member?.memberStatus === 'Adult' ? 'selected' : ''}>Adult</option>
                                    <option value="Child" ${member?.memberStatus === 'Child' ? 'selected' : ''}>Child</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                membersContainer.insertAdjacentHTML('beforeend', memberHtml);
            }
            
            // Add child form dynamically
            function addChildForm(child = null) {
                const childCount = childrenContainer.children.length;
                const childId = child?.ChildID || `new-child-${childCount + 1}`;
                const childHtml = `
                    <div class="card p-4 bg-white text-gray-800 shadow-sm" data-id="${childId}">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Child ${childCount + 1}</h3>
                            <button type="button" class="remove-btn text-red-500 hover:text-red-700 text-xl"><i class="fas fa-trash"></i></button>
                        </div>
                        <input type="hidden" name="childID[]" value="${childId}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="${generateId('childFirstName', childCount)}" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                                <input type="text" id="${generateId('childFirstName', childCount)}" name="childFirstName[]" value="${child?.firstName || ''}" class="w-full p-2 rounded-lg border border-gray-300" required>
                            </div>
                            <div>
                                <label for="${generateId('childLastName', childCount)}" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                                <input type="text" id="${generateId('childLastName', childCount)}" name="childLastName[]" value="${child?.lastName || ''}" class="w-full p-2 rounded-lg border border-gray-300" required>
                            </div>
                            <div>
                                <label for="${generateId('childDateOfBirth', childCount)}" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                                <input type="date" id="${generateId('childDateOfBirth', childCount)}" name="childDateOfBirth[]" value="${child?.dateOfBirth || ''}" class="w-full p-2 rounded-lg border border-gray-300" required>
                            </div>
                            <div>
                                <label for="${generateId('childBaptised', childCount)}" class="block text-sm font-medium text-gray-700 mb-1">Baptised?</label>
                                <select id="${generateId('childBaptised', childCount)}" name="childBaptised[]" class="w-full p-2 rounded-lg border border-gray-300">
                                    <option value="No" ${child?.baptised === 'No' ? 'selected' : ''}>No</option>
                                    <option value="Yes" ${child?.baptised === 'Yes' ? 'selected' : ''}>Yes</option>
                                </select>
                            </div>
                            <div>
                                <label for="${generateId('childFirstCommunion', childCount)}" class="block text-sm font-medium text-gray-700 mb-1">First Communion?</label>
                                <select id="${generateId('childFirstCommunion', childCount)}" name="childFirstCommunion[]" class="w-full p-2 rounded-lg border border-gray-300">
                                    <option value="No" ${child?.firstCommunion === 'No' ? 'selected' : ''}>No</option>
                                    <option value="Yes" ${child?.firstCommunion === 'Yes' ? 'selected' : ''}>Yes</option>
                                </select>
                            </div>
                            <div>
                                <label for="${generateId('childConfirmation', childCount)}" class="block text-sm font-medium text-gray-700 mb-1">Confirmation?</label>
                                <select id="${generateId('childConfirmation', childCount)}" name="childConfirmation[]" class="w-full p-2 rounded-lg border border-gray-300">
                                    <option value="No" ${child?.confirmation === 'No' ? 'selected' : ''}>No</option>
                                    <option value="Yes" ${child?.confirmation === 'Yes' ? 'selected' : ''}>Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                childrenContainer.insertAdjacentHTML('beforeend', childHtml);
            }

            // Remove button event listener
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.target.closest('.card').remove();
                });
            });

            // Add new member/child buttons
            addMemberBtn.addEventListener('click', () => addMemberForm());
            addChildBtn.addEventListener('click', () => addChildForm());

            // Handle form submission
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loadingOverlay.classList.remove('hidden');

                const householdData = {
                    HouseholdID: document.getElementById('householdID').value,
                    Address: document.getElementById('address').value,
                    BlockName: document.getElementById('blockName').value,
                    HouseholdHeadName: document.getElementById('householdHeadName').value
                };

                const members = Array.from(document.querySelectorAll('#membersContainer > .card')).map(card => {
                    return {
                        HouseholdID: householdData.HouseholdID,
                        MemberID: card.dataset.id,
                        firstName: card.querySelector('input[name="firstName[]"]').value,
                        lastName: card.querySelector('input[name="lastName[]"]').value,
                        contactNumber: card.querySelector('input[name="contactNumber[]"]').value,
                        email: card.querySelector('input[name="email[]"]').value,
                        gender: card.querySelector('select[name="gender[]"]').value,
                        memberStatus: card.querySelector('select[name="memberStatus[]"]').value
                    };
                });

                const children = Array.from(document.querySelectorAll('#childrenContainer > .card')).map(card => {
                    return {
                        HouseholdID: householdData.HouseholdID,
                        ChildID: card.dataset.id,
                        firstName: card.querySelector('input[name="childFirstName[]"]').value,
                        lastName: card.querySelector('input[name="childLastName[]"]').value,
                        dateOfBirth: card.querySelector('input[name="childDateOfBirth[]"]').value,
                        baptised: card.querySelector('select[name="childBaptised[]"]').value,
                        firstCommunion: card.querySelector('select[name="childFirstCommunion[]"]').value,
                        confirmation: card.querySelector('select[name="childConfirmation[]"]').value,
                        // Note: Additional fields for dates/churches would need to be added to the form if you want to save them
                    };
                });
                
                const payload = {
                    action: 'updateRecord',
                    household: householdData,
                    members: members,
                    children: children
                };

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify(payload),
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    showMessage('Record updated successfully!', 'bg-green-200 text-green-800');
                } catch (error) {
                    showMessage('An error occurred. Please try again.', 'bg-red-200 text-red-800');
                    console.error('Error submitting form:', error);
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            });

            // Initial fetch to populate the form
            fetchAndPopulateForm();
        });
    </script>
</body>
</html>
